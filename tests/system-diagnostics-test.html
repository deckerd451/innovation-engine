<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Diagnostics Test - CharlestonHacks</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        body {
            font-family: system-ui, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%);
            color: white;
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-section {
            background: rgba(0,224,255,0.05);
            border: 1px solid rgba(0,224,255,0.2);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .status-good { color: #00ff88; }
        .status-warning { color: #ffaa00; }
        .status-error { color: #ff6b6b; }
        .status-info { color: #00e0ff; }
        
        .test-button {
            background: linear-gradient(135deg, #00ff88, #00e0ff);
            border: none;
            border-radius: 8px;
            color: #000;
            padding: 1rem 2rem;
            font-weight: 600;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: all 0.2s;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,255,136,0.3);
        }
        
        .test-output {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
            white-space: pre-wrap;
        }
        
        .test-result {
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 6px;
            border-left: 4px solid;
        }
        
        .test-result.pass {
            background: rgba(0,255,136,0.1);
            border-left-color: #00ff88;
        }
        
        .test-result.fail {
            background: rgba(255,107,107,0.1);
            border-left-color: #ff6b6b;
        }
        
        .test-result.warning {
            background: rgba(255,170,0,0.1);
            border-left-color: #ffaa00;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="status-info">üß™ System Diagnostics Test Suite</h1>
        <p>Comprehensive testing of all system components and initialization fixes.</p>
        
        <div class="test-section">
            <h2 class="status-good">üîß Initialization Tests</h2>
            
            <button class="test-button" onclick="testEventDeduplication()">
                <i class="fas fa-shield-alt"></i> Test Event Deduplication
            </button>
            
            <button class="test-button" onclick="testDuplicateInitPrevention()">
                <i class="fas fa-copy"></i> Test Duplicate Init Prevention
            </button>
            
            <button class="test-button" onclick="testModuleLogging()">
                <i class="fas fa-list"></i> Test Module Logging
            </button>
            
            <div id="init-test-output" class="test-output" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2 class="status-info">üîç Component Tests</h2>
            
            <button class="test-button" onclick="testNetworkFilters()">
                <i class="fas fa-filter"></i> Test Network Filters
            </button>
            
            <button class="test-button" onclick="testConnectionStatus()">
                <i class="fas fa-wifi"></i> Test Connection Status
            </button>
            
            <button class="test-button" onclick="testSynapseHelper()">
                <i class="fas fa-brain"></i> Test Synapse Helper
            </button>
            
            <button class="test-button" onclick="testDailyEngagement()">
                <i class="fas fa-calendar-check"></i> Test Daily Engagement
            </button>
            
            <div id="component-test-output" class="test-output" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2 class="status-warning">üìä Performance Tests</h2>
            
            <button class="test-button" onclick="testEventListenerCount()">
                <i class="fas fa-chart-line"></i> Count Event Listeners
            </button>
            
            <button class="test-button" onclick="testMemoryUsage()">
                <i class="fas fa-memory"></i> Check Memory Usage
            </button>
            
            <button class="test-button" onclick="testInitializationTiming()">
                <i class="fas fa-stopwatch"></i> Test Init Timing
            </button>
            
            <div id="performance-test-output" class="test-output" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2 class="status-error">üö® Issue Detection</h2>
            
            <button class="test-button" onclick="detectDuplicateListeners()">
                <i class="fas fa-search"></i> Detect Duplicate Listeners
            </button>
            
            <button class="test-button" onclick="detectMemoryLeaks()">
                <i class="fas fa-exclamation-triangle"></i> Detect Memory Leaks
            </button>
            
            <button class="test-button" onclick="runFullDiagnostic()">
                <i class="fas fa-stethoscope"></i> Run Full Diagnostic
            </button>
            
            <div id="issue-test-output" class="test-output" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2 class="status-good">üìã Test Results Summary</h2>
            <div id="test-summary">
                <p>Click any test button above to begin testing...</p>
            </div>
        </div>
    </div>

    <script>
        let testResults = [];
        
        function log(message, type = 'info', outputId = 'init-test-output') {
            const output = document.getElementById(outputId);
            if (!output) return;
            
            output.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#00e0ff',
                success: '#00ff88',
                warning: '#ffaa00',
                error: '#ff6b6b'
            };
            
            output.innerHTML += `<span style="color: ${colors[type] || colors.info};">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }
        
        function addTestResult(testName, status, message) {
            testResults.push({ testName, status, message, timestamp: new Date() });
            updateTestSummary();
        }
        
        function updateTestSummary() {
            const summary = document.getElementById('test-summary');
            const passed = testResults.filter(r => r.status === 'pass').length;
            const failed = testResults.filter(r => r.status === 'fail').length;
            const warnings = testResults.filter(r => r.status === 'warning').length;
            
            summary.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div class="test-result pass">
                        <strong>‚úÖ Passed: ${passed}</strong>
                    </div>
                    <div class="test-result fail">
                        <strong>‚ùå Failed: ${failed}</strong>
                    </div>
                    <div class="test-result warning">
                        <strong>‚ö†Ô∏è Warnings: ${warnings}</strong>
                    </div>
                </div>
                
                <div style="max-height: 300px; overflow-y: auto;">
                    ${testResults.map(result => `
                        <div class="test-result ${result.status}">
                            <strong>${result.testName}</strong><br>
                            ${result.message}<br>
                            <small>${result.timestamp.toLocaleTimeString()}</small>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Test Functions
        function testEventDeduplication() {
            log('üîç Testing event deduplication system...', 'info', 'init-test-output');
            
            try {
                // Check if deduplication system is loaded
                if (typeof window.__CH_EVENT_REGISTRY__ !== 'undefined') {
                    log('‚úÖ Event registry found', 'success', 'init-test-output');
                    addTestResult('Event Deduplication', 'pass', 'Event registry system is active');
                } else {
                    log('‚ùå Event registry not found', 'error', 'init-test-output');
                    addTestResult('Event Deduplication', 'fail', 'Event registry system not loaded');
                    return;
                }
                
                // Test duplicate prevention
                let duplicateCount = 0;
                const testListener = () => duplicateCount++;
                
                // Add same listener multiple times
                window.addEventListener('test-event', testListener);
                window.addEventListener('test-event', testListener);
                window.addEventListener('test-event', testListener);
                
                // Trigger event
                window.dispatchEvent(new CustomEvent('test-event'));
                
                if (duplicateCount === 1) {
                    log('‚úÖ Duplicate listeners prevented successfully', 'success', 'init-test-output');
                    addTestResult('Duplicate Prevention', 'pass', 'Only one listener executed despite multiple bindings');
                } else {
                    log(`‚ö†Ô∏è Expected 1 execution, got ${duplicateCount}`, 'warning', 'init-test-output');
                    addTestResult('Duplicate Prevention', 'warning', `${duplicateCount} listeners executed`);
                }
                
            } catch (error) {
                log(`‚ùå Event deduplication test failed: ${error.message}`, 'error', 'init-test-output');
                addTestResult('Event Deduplication', 'fail', error.message);
            }
        }

        function testDuplicateInitPrevention() {
            log('üîç Testing duplicate initialization prevention...', 'info', 'init-test-output');
            
            try {
                // Test initGuard function
                if (typeof window.initGuard === 'function') {
                    log('‚úÖ initGuard function available', 'success', 'init-test-output');
                    
                    let initCount = 0;
                    const testInit = () => { initCount++; return 'initialized'; };
                    
                    // Try to initialize multiple times
                    window.initGuard('TestModule', testInit);
                    window.initGuard('TestModule', testInit);
                    window.initGuard('TestModule', testInit);
                    
                    if (initCount === 1) {
                        log('‚úÖ Duplicate initialization prevented', 'success', 'init-test-output');
                        addTestResult('Init Guard', 'pass', 'Module initialized only once despite multiple calls');
                    } else {
                        log(`‚ö†Ô∏è Expected 1 init, got ${initCount}`, 'warning', 'init-test-output');
                        addTestResult('Init Guard', 'warning', `Module initialized ${initCount} times`);
                    }
                } else {
                    log('‚ùå initGuard function not available', 'error', 'init-test-output');
                    addTestResult('Init Guard', 'fail', 'initGuard function not found');
                }
                
            } catch (error) {
                log(`‚ùå Init prevention test failed: ${error.message}`, 'error', 'init-test-output');
                addTestResult('Init Prevention', 'fail', error.message);
            }
        }

        function testModuleLogging() {
            log('üîç Testing module logging completeness...', 'info', 'init-test-output');
            
            const expectedLogs = [
                'Network filters initialized',
                'Connection status indicator initialized',
                'Synapse initialization helper ready',
                'Daily engagement ready'
            ];
            
            // This would need to check console logs in a real implementation
            // For now, we'll simulate the check
            log('‚ÑπÔ∏è Module logging test requires console inspection', 'info', 'init-test-output');
            log('üí° Check browser console for completion messages', 'info', 'init-test-output');
            
            addTestResult('Module Logging', 'warning', 'Manual verification required - check console logs');
        }

        function testNetworkFilters() {
            log('üîç Testing network filters functionality...', 'info', 'component-test-output');
            
            try {
                if (typeof window.initNetworkFilters === 'function') {
                    log('‚úÖ Network filters function available', 'success', 'component-test-output');
                    
                    // Test initialization
                    const controller = window.initNetworkFilters();
                    
                    if (controller && typeof controller.open === 'function') {
                        log('‚úÖ Network filters controller working', 'success', 'component-test-output');
                        addTestResult('Network Filters', 'pass', 'Initialization and controller functions working');
                    } else {
                        log('‚ö†Ô∏è Network filters controller incomplete', 'warning', 'component-test-output');
                        addTestResult('Network Filters', 'warning', 'Controller missing expected functions');
                    }
                } else {
                    log('‚ùå Network filters function not available', 'error', 'component-test-output');
                    addTestResult('Network Filters', 'fail', 'initNetworkFilters function not found');
                }
                
            } catch (error) {
                log(`‚ùå Network filters test failed: ${error.message}`, 'error', 'component-test-output');
                addTestResult('Network Filters', 'fail', error.message);
            }
        }

        function testConnectionStatus() {
            log('üîç Testing connection status indicator...', 'info', 'component-test-output');
            
            try {
                if (typeof window.connectionStatus === 'object' && window.connectionStatus.update) {
                    log('‚úÖ Connection status object available', 'success', 'component-test-output');
                    
                    // Test status update
                    window.connectionStatus.update('ready', 'Test message');
                    log('‚úÖ Connection status update working', 'success', 'component-test-output');
                    
                    setTimeout(() => {
                        window.connectionStatus.hide();
                        log('‚úÖ Connection status hide working', 'success', 'component-test-output');
                    }, 1000);
                    
                    addTestResult('Connection Status', 'pass', 'Status indicator functions working correctly');
                } else {
                    log('‚ùå Connection status not available', 'error', 'component-test-output');
                    addTestResult('Connection Status', 'fail', 'Connection status object not found');
                }
                
            } catch (error) {
                log(`‚ùå Connection status test failed: ${error.message}`, 'error', 'component-test-output');
                addTestResult('Connection Status', 'fail', error.message);
            }
        }

        function testSynapseHelper() {
            log('üîç Testing synapse initialization helper...', 'info', 'component-test-output');
            
            try {
                if (typeof window.ensureSynapseInitialized === 'function') {
                    log('‚úÖ Synapse helper function available', 'success', 'component-test-output');
                    
                    // Test helper functionality
                    window.ensureSynapseInitialized().then(() => {
                        log('‚úÖ Synapse helper working correctly', 'success', 'component-test-output');
                        addTestResult('Synapse Helper', 'pass', 'Helper function executed successfully');
                    }).catch((error) => {
                        log(`‚ö†Ô∏è Synapse helper completed with issues: ${error.message}`, 'warning', 'component-test-output');
                        addTestResult('Synapse Helper', 'warning', `Helper completed with issues: ${error.message}`);
                    });
                } else {
                    log('‚ùå Synapse helper function not available', 'error', 'component-test-output');
                    addTestResult('Synapse Helper', 'fail', 'ensureSynapseInitialized function not found');
                }
                
            } catch (error) {
                log(`‚ùå Synapse helper test failed: ${error.message}`, 'error', 'component-test-output');
                addTestResult('Synapse Helper', 'fail', error.message);
            }
        }

        function testDailyEngagement() {
            log('üîç Testing daily engagement system...', 'info', 'component-test-output');
            
            try {
                if (typeof window.DailyEngagement === 'object') {
                    log('‚úÖ Daily engagement object available', 'success', 'component-test-output');
                    
                    const state = window.DailyEngagement.getState();
                    if (state) {
                        log('‚úÖ Daily engagement state accessible', 'success', 'component-test-output');
                        addTestResult('Daily Engagement', 'pass', 'System loaded and state accessible');
                    } else {
                        log('‚ö†Ô∏è Daily engagement state not available', 'warning', 'component-test-output');
                        addTestResult('Daily Engagement', 'warning', 'System loaded but state not accessible');
                    }
                } else {
                    log('‚ùå Daily engagement not available', 'error', 'component-test-output');
                    addTestResult('Daily Engagement', 'fail', 'DailyEngagement object not found');
                }
                
            } catch (error) {
                log(`‚ùå Daily engagement test failed: ${error.message}`, 'error', 'component-test-output');
                addTestResult('Daily Engagement', 'fail', error.message);
            }
        }

        function testEventListenerCount() {
            log('üîç Counting event listeners...', 'info', 'performance-test-output');
            
            try {
                if (typeof window.showListenerStats === 'function') {
                    const stats = window.showListenerStats();
                    
                    const totalListeners = Object.values(stats).reduce((sum, count) => sum + count, 0);
                    log(`üìä Total event listeners: ${totalListeners}`, 'info', 'performance-test-output');
                    
                    // Check for excessive listeners
                    const excessiveTypes = Object.entries(stats).filter(([type, count]) => count > 10);
                    
                    if (excessiveTypes.length === 0) {
                        log('‚úÖ Event listener counts look healthy', 'success', 'performance-test-output');
                        addTestResult('Event Listener Count', 'pass', `${totalListeners} total listeners, no excessive counts`);
                    } else {
                        log(`‚ö†Ô∏è Some event types have many listeners: ${excessiveTypes.map(([type, count]) => `${type}: ${count}`).join(', ')}`, 'warning', 'performance-test-output');
                        addTestResult('Event Listener Count', 'warning', `Excessive listeners detected: ${excessiveTypes.length} types`);
                    }
                } else {
                    log('‚ùå Listener stats function not available', 'error', 'performance-test-output');
                    addTestResult('Event Listener Count', 'fail', 'showListenerStats function not found');
                }
                
            } catch (error) {
                log(`‚ùå Event listener count test failed: ${error.message}`, 'error', 'performance-test-output');
                addTestResult('Event Listener Count', 'fail', error.message);
            }
        }

        function testMemoryUsage() {
            log('üîç Checking memory usage...', 'info', 'performance-test-output');
            
            try {
                if (performance.memory) {
                    const memory = performance.memory;
                    const usedMB = Math.round(memory.usedJSHeapSize / 1024 / 1024);
                    const totalMB = Math.round(memory.totalJSHeapSize / 1024 / 1024);
                    const limitMB = Math.round(memory.jsHeapSizeLimit / 1024 / 1024);
                    
                    log(`üìä Memory usage: ${usedMB}MB / ${totalMB}MB (limit: ${limitMB}MB)`, 'info', 'performance-test-output');
                    
                    const usagePercent = (usedMB / limitMB) * 100;
                    
                    if (usagePercent < 50) {
                        log('‚úÖ Memory usage is healthy', 'success', 'performance-test-output');
                        addTestResult('Memory Usage', 'pass', `${usagePercent.toFixed(1)}% of limit used`);
                    } else if (usagePercent < 80) {
                        log('‚ö†Ô∏è Memory usage is elevated', 'warning', 'performance-test-output');
                        addTestResult('Memory Usage', 'warning', `${usagePercent.toFixed(1)}% of limit used`);
                    } else {
                        log('‚ùå Memory usage is high', 'error', 'performance-test-output');
                        addTestResult('Memory Usage', 'fail', `${usagePercent.toFixed(1)}% of limit used`);
                    }
                } else {
                    log('‚ÑπÔ∏è Memory API not available in this browser', 'info', 'performance-test-output');
                    addTestResult('Memory Usage', 'warning', 'Memory API not supported');
                }
                
            } catch (error) {
                log(`‚ùå Memory usage test failed: ${error.message}`, 'error', 'performance-test-output');
                addTestResult('Memory Usage', 'fail', error.message);
            }
        }

        function testInitializationTiming() {
            log('üîç Testing initialization timing...', 'info', 'performance-test-output');
            
            try {
                const startTime = performance.now();
                
                // Simulate initialization
                setTimeout(() => {
                    const endTime = performance.now();
                    const duration = endTime - startTime;
                    
                    log(`‚è±Ô∏è Simulated init took ${duration.toFixed(2)}ms`, 'info', 'performance-test-output');
                    
                    if (duration < 100) {
                        log('‚úÖ Initialization timing is excellent', 'success', 'performance-test-output');
                        addTestResult('Init Timing', 'pass', `${duration.toFixed(2)}ms - excellent performance`);
                    } else if (duration < 500) {
                        log('‚úÖ Initialization timing is good', 'success', 'performance-test-output');
                        addTestResult('Init Timing', 'pass', `${duration.toFixed(2)}ms - good performance`);
                    } else {
                        log('‚ö†Ô∏è Initialization timing is slow', 'warning', 'performance-test-output');
                        addTestResult('Init Timing', 'warning', `${duration.toFixed(2)}ms - slow performance`);
                    }
                }, 50);
                
            } catch (error) {
                log(`‚ùå Initialization timing test failed: ${error.message}`, 'error', 'performance-test-output');
                addTestResult('Init Timing', 'fail', error.message);
            }
        }

        function detectDuplicateListeners() {
            log('üîç Detecting duplicate listeners...', 'info', 'issue-test-output');
            
            try {
                if (typeof window.__CH_EVENT_REGISTRY__ !== 'undefined') {
                    const registry = window.__CH_EVENT_REGISTRY__;
                    const eventTypes = {};
                    
                    for (const [key, info] of registry.entries()) {
                        eventTypes[info.type] = (eventTypes[info.type] || 0) + 1;
                    }
                    
                    const duplicates = Object.entries(eventTypes).filter(([type, count]) => count > 5);
                    
                    if (duplicates.length === 0) {
                        log('‚úÖ No excessive duplicate listeners detected', 'success', 'issue-test-output');
                        addTestResult('Duplicate Detection', 'pass', 'No problematic duplicates found');
                    } else {
                        log(`‚ö†Ô∏è Potential duplicates found: ${duplicates.map(([type, count]) => `${type}: ${count}`).join(', ')}`, 'warning', 'issue-test-output');
                        addTestResult('Duplicate Detection', 'warning', `${duplicates.length} event types with many listeners`);
                    }
                } else {
                    log('‚ùå Event registry not available for duplicate detection', 'error', 'issue-test-output');
                    addTestResult('Duplicate Detection', 'fail', 'Event registry not available');
                }
                
            } catch (error) {
                log(`‚ùå Duplicate detection failed: ${error.message}`, 'error', 'issue-test-output');
                addTestResult('Duplicate Detection', 'fail', error.message);
            }
        }

        function detectMemoryLeaks() {
            log('üîç Detecting potential memory leaks...', 'info', 'issue-test-output');
            
            try {
                // Check for common memory leak patterns
                const globalVars = Object.keys(window).filter(key => key.startsWith('__CH_'));
                log(`üìä Found ${globalVars.length} CharlestonHacks global variables`, 'info', 'issue-test-output');
                
                // Check for excessive DOM elements
                const totalElements = document.querySelectorAll('*').length;
                log(`üìä Total DOM elements: ${totalElements}`, 'info', 'issue-test-output');
                
                if (totalElements > 5000) {
                    log('‚ö†Ô∏è High DOM element count may indicate memory issues', 'warning', 'issue-test-output');
                    addTestResult('Memory Leak Detection', 'warning', `${totalElements} DOM elements - high count`);
                } else {
                    log('‚úÖ DOM element count looks healthy', 'success', 'issue-test-output');
                    addTestResult('Memory Leak Detection', 'pass', `${totalElements} DOM elements - healthy count`);
                }
                
            } catch (error) {
                log(`‚ùå Memory leak detection failed: ${error.message}`, 'error', 'issue-test-output');
                addTestResult('Memory Leak Detection', 'fail', error.message);
            }
        }

        function runFullDiagnostic() {
            log('üîç Running full diagnostic suite...', 'info', 'issue-test-output');
            
            // Clear previous results
            testResults = [];
            
            // Run all tests
            setTimeout(() => testEventDeduplication(), 100);
            setTimeout(() => testDuplicateInitPrevention(), 200);
            setTimeout(() => testNetworkFilters(), 300);
            setTimeout(() => testConnectionStatus(), 400);
            setTimeout(() => testSynapseHelper(), 500);
            setTimeout(() => testDailyEngagement(), 600);
            setTimeout(() => testEventListenerCount(), 700);
            setTimeout(() => testMemoryUsage(), 800);
            setTimeout(() => testInitializationTiming(), 900);
            setTimeout(() => detectDuplicateListeners(), 1000);
            setTimeout(() => detectMemoryLeaks(), 1100);
            
            setTimeout(() => {
                log('‚úÖ Full diagnostic suite completed', 'success', 'issue-test-output');
                log('üìä Check test results summary below', 'info', 'issue-test-output');
            }, 1200);
        }

        // Initialize test page
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üß™ System Diagnostics Test Suite loaded');
            
            // Show initial status
            setTimeout(() => {
                const summary = document.getElementById('test-summary');
                summary.innerHTML = `
                    <div class="test-result pass">
                        <strong>üöÄ Test Suite Ready</strong><br>
                        Click any test button above to begin diagnostics.<br>
                        <small>Loaded at ${new Date().toLocaleTimeString()}</small>
                    </div>
                `;
            }, 100);
        });
    </script>
</body>
</html>