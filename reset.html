<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const supabaseUrl = "https://mqbsjlgnsirqsmfnreqd.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xYnNqbGduc2lycXNtZm5yZXFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1ODQyNzIsImV4cCI6MjA4NjE2MDI3Mn0.fF4_q0Di_1irDzTiuTRbuit61jclGyZw7ff2Q928QXc";
  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  const statusMsg = document.getElementById("status-msg");
  const formEl = document.getElementById("form");
  const feedbackEl = document.getElementById("feedback");
  const btnEl = document.getElementById("btn");

  function showError(msg) {
    feedbackEl.textContent = msg;
    feedbackEl.className = "error";
  }

  function showSuccess(msg) {
    feedbackEl.textContent = msg;
    feedbackEl.className = "success";
  }

  function revealForm() {
    statusMsg.textContent = "Enter your new password below.";
    formEl.style.display = "block";
  }

  async function ensureRecoverySessionFromUrl() {
    // 1) PKCE-style: ?code=...
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (code) {
  statusMsg.textContent = "Verifying reset link…";
  const { data, error } = await supabase.auth.exchangeCodeForSession(code);

  if (error) {
    statusMsg.textContent = "Reset link could not be verified.";
    showError(error.message);
    return false;
  }

  revealForm();   // ✅ show the password fields now
  return true;    // ✅ prevents your “no session found” fallback
}


      if (data?.session) return true;
      // If exchange succeeded but no session for some reason:
      statusMsg.textContent = "No reset session found (after exchange).";
      return false;
    }

    // 2) Older hash-token style: #access_token=...
    // supabase-js can parse this automatically via getSession() after page load
    const { data, error } = await supabase.auth.getSession();
    if (error) {
      statusMsg.textContent = "Error verifying reset link.";
      showError(error.message);
      return false;
    }
    return !!data.session;
  }

  // Initialize
  const hasSession = await ensureRecoverySessionFromUrl();
  if (hasSession) {
    revealForm();
  } else {
    statusMsg.textContent =
      "No reset session found. Open the reset link from your email again, or request a new one.";
  }

  // Handle submission
  btnEl.addEventListener("click", async () => {
    const p1 = document.getElementById("p1").value;
    const p2 = document.getElementById("p2").value;

    if (p1.length < 8) return showError("Password must be at least 8 characters.");
    if (p1 !== p2) return showError("Passwords do not match.");

    btnEl.disabled = true;
    btnEl.textContent = "Updating…";
    feedbackEl.textContent = "";
    feedbackEl.className = "";

    const { error } = await supabase.auth.updateUser({ password: p1 });

    if (error) {
      showError("Error: " + error.message);
      btnEl.disabled = false;
      btnEl.textContent = "Set new password";
      return;
    }

    showSuccess("Password updated! Redirecting…");
    setTimeout(() => {
      window.location.href = "https://deckerd451.github.io/innovation-engine/";
    }, 1200);
  });
</script>
