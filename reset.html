<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // ✅ Project config (Legacy anon JWT key is correct for client apps)
  const supabaseUrl = "https://mqbsjlgnsirqsmfnreqd.supabase.co";
  const supabaseAnonKey =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xYnNqbGduc2lycXNtZm5yZXFkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1ODQyNzIsImV4cCI6MjA4NjE2MDI3Mn0.fF4_q0Di_1irDzTiuTRbuit61jclGyZw7ff2Q928QXc";

  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  const statusMsg = document.getElementById("status-msg");
  const formEl = document.getElementById("form");
  const feedbackEl = document.getElementById("feedback");
  const btnEl = document.getElementById("btn");
  const p1El = document.getElementById("p1");
  const p2El = document.getElementById("p2");

  const APP_HOME = "https://deckerd451.github.io/innovation-engine/";

  function setStatus(msg) {
    statusMsg.textContent = msg;
  }

  function showError(msg) {
    feedbackEl.textContent = msg || "";
    feedbackEl.className = msg ? "error" : "";
  }

  function showSuccess(msg) {
    feedbackEl.textContent = msg || "";
    feedbackEl.className = msg ? "success" : "";
  }

  function revealForm() {
    setStatus("Enter your new password below.");
    formEl.style.display = "block";
  }

  function disableButton(disabled, label) {
    btnEl.disabled = disabled;
    if (label) btnEl.textContent = label;
  }

  function getCodeParam() {
    const params = new URLSearchParams(window.location.search);
    return params.get("code");
  }

  async function establishRecoverySession() {
    // 1) Preferred path: PKCE-style link with ?code=...
    const code = getCodeParam();
    if (code) {
      setStatus("Verifying reset link… (do not refresh)");
      const { data, error } = await supabase.auth.exchangeCodeForSession(code);

      if (error) {
        // Common cause: code already used (page refreshed or opened twice)
        showError(error.message);
        setStatus(
          "Reset link could not be verified. Request a new reset email and open the newest link once."
        );
        return false;
      }

      if (data?.session) return true;

      showError("No session returned after code exchange.");
      setStatus("Reset link verified, but no session was created. Request a new reset email.");
      return false;
    }

    // 2) Fallback: older hash-token style (#access_token=...) or if session already exists
    const { data, error } = await supabase.auth.getSession();
    if (error) {
      showError(error.message);
      setStatus("Error verifying reset link.");
      return false;
    }

    return !!data?.session;
  }

  async function init() {
    showError("");
    showSuccess("");
    formEl.style.display = "none";
    disableButton(true, "Set new password");

    const hasSession = await establishRecoverySession();
    if (!hasSession) {
      // No session = can’t update password
      // (usually means opened wrong link, refreshed, or link expired)
      disableButton(true, "Set new password");
      return;
    }

    // Session exists → allow password update
    revealForm();
    disableButton(false, "Set new password");

    // Optional: focus first field for UX
    setTimeout(() => p1El?.focus(), 50);
  }

  btnEl.addEventListener("click", async () => {
    showError("");
    showSuccess("");

    const p1 = (p1El?.value || "").trim();
    const p2 = (p2El?.value || "").trim();

    if (p1.length < 8) {
      showError("Password must be at least 8 characters.");
      return;
    }
    if (p1 !== p2) {
      showError("Passwords do not match.");
      return;
    }

    disableButton(true, "Updating…");

    // Double-check we still have a session before updating
    const { data: sessData } = await supabase.auth.getSession();
    if (!sessData?.session) {
      showError("No reset session found. Please open the newest reset link from your email again.");
      disableButton(false, "Set new password");
      return;
    }

    const { error } = await supabase.auth.updateUser({ password: p1 });
    if (error) {
      showError(error.message);
      disableButton(false, "Set new password");
      return;
    }

    showSuccess("Password updated! Redirecting…");
    setTimeout(() => {
      window.location.href = APP_HOME;
    }, 1200);
  });

  // Run
  init();
</script>
