<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Cache refresh: FORCE DEPLOYMENT -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <title>CharlestonHacks Innovation Engine</title>
  <link rel="icon" href="favicon.ico"/>
  <link rel="manifest" href="./manifest.json">

  <!-- Core CSS (bump on deploy) -->
  <link rel="stylesheet" href="assets/css/base.css?v=20260220-1" />
  <link rel="stylesheet" href="assets/css/engine.css?v=20260220-1" />
  <link rel="stylesheet" href="assets/css/overlays.css?v=20260220-1" />
  <link rel="stylesheet" href="assets/css/connections.css?v=20260220-1" />
  <link rel="stylesheet" href="assets/css/messaging.css?v=20260220-1" />
  <link rel="stylesheet" href="dashboard.css?v=20260220-1" />
  <link rel="stylesheet" href="assets/css/synapse-progressive-disclosure.css?v=20260220-1" />
  <link rel="stylesheet" href="assets/css/quiet-mode.css?v=20260220-1" />
  <link rel="stylesheet" href="assets/css/mobile-safe-area.css?v=20260220-1" />

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root { --vh: 1vh; --real-vh: 1vh; }

    html, body, #main-content, #synapse-main-view, #synapse-svg, .unified-main {
      background: #000 !important;
      background-color: #000 !important;
    }

    #main-content, #synapse-main-view, .unified-main {
      margin: 0 !important; padding: 0 !important; border: none !important;
      max-width: none !important;
    }

    html, body {
      margin: 0 !important;
      padding: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      height: calc(var(--vh, 1vh) * 100) !important;
      overflow: hidden !important;
      overflow-x: hidden !important;
      position: fixed !important;
      touch-action: pan-y pinch-zoom !important;
    }

    input, textarea, select { font-size: 16px !important; }

    @supports (-webkit-touch-callout: none) {
      body { position: fixed !important; width: 100% !important; }
    }

    body::before, body::after, html::before, html::after { display: none !important; }

    body { overflow: hidden; }
  </style>
  
  <script>
(function(){
  let _val = window.initLoginSystem;
  Object.defineProperty(window, "initLoginSystem", {
    configurable: true,
    get(){ return _val; },
    set(v){
      console.warn("[TRAP] initLoginSystem overwritten by:", (new Error()).stack);
      _val = v;
    }
  });
})();
</script>
  
</head>

<body>
  <!-- Neural Background -->
  <canvas id="neural-bg"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
    background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%);"></canvas>

  <!-- Login -->
  <div id="login-section" class="active-tab-pane"
    style="position: fixed; inset: 0; width: 100vw; height: 100vh; height: calc(var(--vh, 1vh) * 100); display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
    z-index: 9999; overflow-y: auto; padding: 1.5rem 1rem; box-sizing: border-box; background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%);">
    <div class="login-container">
      <img src="ieheader.webp"
           alt="CharlestonHacks Innovation Engine"
           style="max-width: 100%; height: auto; margin-bottom: 1rem;"
           onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
      <h1 style="display:none; color:#00e0ff; font-size:2rem; margin-bottom:1rem;">CharlestonHacks Innovation Engine</h1>

      <h2 style="color:#00e0ff; font-size:1.5rem; font-weight:bold; margin-bottom:0.75rem;">
        Making Invisible Networks Visible
      </h2>

      <p style="color:#ddd; font-size:1.1rem; line-height:1.6; margin-bottom:2rem; max-width:520px;">
        Discover people, skills, and collaboration opportunities in your innovation ecosystem.
        Connect with the right people, join projects, and build something amazing together.
      </p>

      <div class="oauth-buttons">
        <button id="github-login" class="oauth-btn">
          <span class="oauth-icon-circle">
            <i class="fab fa-github"></i>
          </span>
          Continue with GitHub
        </button>
        <button id="google-login" class="oauth-btn">
          <span class="oauth-icon-circle">
            <i class="fab fa-google"></i>
          </span>
          Continue with Google
        </button>
      </div>

      <!-- Email / Password Login (unchanged) -->
      <div id="email-auth-section" style="margin-top:1.5rem; width:100%;">
        <div style="display:flex; align-items:center; gap:1rem; margin-bottom:1.25rem;">
          <hr style="flex:1; border:none; border-top:1px solid rgba(255,255,255,0.15);">
          <span style="color:#888; font-size:0.85rem; white-space:nowrap;">or sign in with email</span>
          <hr style="flex:1; border:none; border-top:1px solid rgba(255,255,255,0.15);">
        </div>
        <div style="display:flex; flex-direction:column; gap:0.75rem;">
          <input id="email-input" type="email" placeholder="Email address"
            style="width:100%; padding:0.875rem 1rem; background:rgba(255,255,255,0.07);
            border:1px solid rgba(0,224,255,0.25); border-radius:8px; color:#fff;
            font-size:1rem; outline:none; box-sizing:border-box;" />
          <input id="password-input" type="password" placeholder="Password"
            style="width:100%; padding:0.875rem 1rem; background:rgba(255,255,255,0.07);
            border:1px solid rgba(0,224,255,0.25); border-radius:8px; color:#fff;
            font-size:1rem; outline:none; box-sizing:border-box;" />
          <div id="email-auth-msg" style="display:none; font-size:0.875rem; text-align:left; padding:0.25rem 0;"></div>
          <button id="email-login-btn" class="oauth-btn"
            style="background:linear-gradient(135deg,rgba(0,224,255,0.1),rgba(0,128,255,0.1));
            border-color:rgba(0,224,255,0.35);">
            <span class="oauth-icon-circle">
              <i class="fas fa-envelope"></i>
            </span>
            Sign in with Email
          </button>
          <div style="text-align:right; margin-top:0.1rem;">
            <a id="forgot-password-link" href="#"
              style="color:#00e0ff; font-size:0.875rem; text-decoration:none; opacity:0.75;">Forgot password?</a>
          </div>
        </div>
      </div>

      <div id="login-hint" style="margin-top: 1rem; color: #aaa; font-size: 0.9rem;"></div>
    </div>
  </div>

  <!-- =========================================================
       MAIN APP DOM
       (Your full app markup can remain as-is)
       I am leaving your existing main-content & modals unchanged
       because they are not the cause of OAuth failure.
  ========================================================== -->

  <!-- KEEP YOUR ENTIRE EXISTING MAIN CONTENT + MODALS HERE -->
  <!-- (Paste your existing #main-content, modals, mentor panels, etc.) -->
  <!-- IMPORTANT: Do not re-add the old force-signout script below. -->

  <!-- External libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

  <!-- Boot diagnostics first -->
  <script src="assets/js/boot-diagnostics.js?v=20260220-1"></script>

  <script type="module" src="assets/js/logger.js?v=fc09b39b-17701461547"></script>
  <script type="module" src="assets/js/animation-lifecycle.js?v=1"></script>
  <script src="assets/js/boot-gate.js?v=1"></script>

  <!-- Supabase client (already imported early for OAuth exchange, but safe to keep) -->
  <script type="module" src="assets/js/supabaseClient.js?v=fc09b39b-1770146154f916933b2da"></script>

  <!-- Your existing modules (keep them) -->
  <script src="assets/js/bootstrapSession.js?v=6e6a1b33"></script>
  <script src="assets/js/realtimeManager.js?v=6e6a1b33"></script>
  <script src="assets/js/migrationHelper.js?v=phase2"></script>
  <script src="assets/js/startupMetrics.js?v=6e6a1b33"></script>

  <script type="module" src="auth.js?v=fc09b39b-1770146154f916933b2da"></script>
  <script type="module" src="profile.js?v=20260220-1"></script>

  <!-- ...keep the rest of your existing script tags exactly as you had them... -->

  <!-- =========================================================
       ✅ HARD-WIRED OAUTH BUTTON HANDLER (cannot be skipped)
       - Ensures clicking buttons actually initiates OAuth
       - Uses redirectTo origin+pathname (keeps /innovation-engine/)
       - Logs a clear error if it fails
  ========================================================== -->
  <script type="module">
    (async () => {
      // Wait until supabase exists
      const waitForSupabase = async (ms = 5000) => {
        const start = Date.now();
        while (Date.now() - start < ms) {
          if (window.supabase?.auth) return window.supabase;
          await new Promise(r => setTimeout(r, 50));
        }
        return null;
      };

      const supabase = await waitForSupabase();
      if (!supabase) {
        console.error("[OAUTH] supabase not ready — cannot wire login buttons.");
        return;
      }

      const redirectTo = `${location.origin}${location.pathname}`; // critical for GH Pages project path
      const wire = (id, provider) => {
        const btn = document.getElementById(id);
        if (!btn) return;

        if (btn.dataset.oauthWired === "1") return;
        btn.dataset.oauthWired = "1";

        btn.addEventListener("click", async (e) => {
          e.preventDefault();
          e.stopPropagation();

          try {
            console.log(`[OAUTH] Starting ${provider} login. redirectTo=`, redirectTo);
            const { data, error } = await supabase.auth.signInWithOAuth({
              provider,
              options: { redirectTo }
            });
            console.log("[OAUTH] signInWithOAuth returned:", { data, error });
            if (error) alert(`OAuth error: ${error.message}`);
          } catch (err) {
            console.error("[OAUTH] signInWithOAuth crashed:", err);
            alert("OAuth failed to start. See console for details.");
          }
        }, true);
      };

      wire("github-login", "github");
      wire("google-login", "google");
    })();
  </script>

  <!-- =========================================================
       ✅ FORCE SIGN-OUT — OPT-IN ONLY
       Use: ?forceSignout=1
       (Never sabotage normal auth again)
  ========================================================== -->
  <script>
    (function () {
      const url = new URL(location.href);
      if (url.searchParams.get("forceSignout") !== "1") return;

      try {
        const keys = Object.keys(localStorage).filter(k => k.startsWith("supabase") || k.startsWith("sb-"));
        keys.forEach(k => localStorage.removeItem(k));
        console.warn("[force-signout] cleared auth keys:", keys);
        alert("Force sign-out complete. Reloading…");
        location.href = url.pathname; // strip query
      } catch (e) {
        console.warn("[force-signout] failed:", e);
      }
    })();
  </script>

  <!-- Dynamic viewport height detection (keep) -->
  <script>
    (function() {
      function setViewportHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      }
      setViewportHeight();
      let t;
      window.addEventListener('resize', () => { clearTimeout(t); t = setTimeout(setViewportHeight, 100); });
      document.addEventListener('visibilitychange', () => { if (!document.hidden) setTimeout(setViewportHeight, 100); });
      console.log('✅ Dynamic viewport height detection initialized');
    })();
  </script>

  <!-- Service worker registration (keep) -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js", { scope: "./" })
          .catch((err) => console.error("SW registration failed:", err));
      });
    }
  </script>
</body>
</html>
