// ===============================================
// CharlestonHacks Card Flip Logic (Enhanced)
// ===============================================
// ✅ Flips between random cards
// ✅ Plays sound & video
// ✅ Shows BTC tracker when Descartes.png appears
// ✅ Triggers chat bubble when Medusa.png appears
// ===============================================

import { setupChatBubble } from './chatBubble.js';

export function initCardFlip(CONFIG) {
  const missionImage = document.getElementById('missionImage');
  const missionVideo = document.getElementById('missionVideo');
  const cardFrame    = document.getElementById('cardFrame');
  const btcElement   = document.getElementById('btcPrice');

  if (!missionImage || !missionVideo || !cardFrame) return;

  const getRandomCardImage = () =>
    CONFIG.cardImages[Math.floor(Math.random() * CONFIG.cardImages.length)];

  const getRandomFlipClass = () =>
    Math.random() > 0.5 ? 'flip-image-x' : 'flip-image-y';

  const getRandomVideo = () =>
    CONFIG.videos[Math.floor(Math.random() * CONFIG.videos.length)];

  const playSound = (key) => {
    const audio = CONFIG.sounds[key];
    if (audio) {
      audio.currentTime = 0;
      audio.volume = key === 'cardflip' ? 0.45 : 0.7;
      audio.play().catch(() => {});
    }
  };

  // ---- BTC Visibility Logic ----
  function updateBTCVisibility(src) {
    if (!btcElement) return;
    if (src.includes('Descartes.png')) btcElement.classList.add('visible');
    else btcElement.classList.remove('visible');
  }

  let videoPlaying = false;

  missionImage.addEventListener('click', () => {
    if (videoPlaying) return;

    const flipClass = getRandomFlipClass();
    const newImage = getRandomCardImage();

    missionImage.src = newImage;
    missionImage.classList.add(flipClass);
    playSound('cardflip');

    if (newImage.includes('Medusa.png')) setupChatBubble();
    updateBTCVisibility(newImage);

    setTimeout(() => missionImage.classList.remove(flipClass), 1200);

    const videoSrc = getRandomVideo();
    missionVideo.src = videoSrc;
    missionVideo.style.display = 'block';
    cardFrame.style.display = 'block';
    setTimeout(() => (missionVideo.style.opacity = 1), 100);

    missionVideo.muted = false;
    window.matchMedia('(max-width: 600px)').matches
      ? missionVideo.removeAttribute('controls')
      : missionVideo.setAttribute('controls', '');

    missionVideo.load();
    missionVideo.play();
    videoPlaying = true;

    missionVideo.onended = () => {
      missionVideo.pause();
      missionVideo.style.display = 'none';
      missionVideo.style.opacity = 0;
      cardFrame.style.display = 'none';
      videoPlaying = false;
    };
  });

  missionImage.setAttribute('tabindex', '0');
  missionImage.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') missionImage.click();
  });
}
