<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CharlestonHacks Innovation Engine</title>
  <link rel="icon" href="favicon.ico"/>
  <link rel="stylesheet" href="assets/css/base.css" />
  <link rel="stylesheet" href="assets/css/engine.css" />
  <link rel="stylesheet" href="assets/css/overlays.css" />
  <link rel="stylesheet" href="assets/css/connections.css" />
  <link rel="stylesheet" href="assets/css/cynq.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="dashboard.css" />
</head>
<body>
  <!-- Neural Network Background -->
  <canvas id="neural-bg" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%);"></canvas>

  <!-- Login Section -->
  <div id="login-section" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; z-index: 9999; overflow: hidden; background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%);">
    <div class="login-container">
      <img src="ieheader.webp" 
           alt="CharlestonHacks Innovation Engine" 
           style="max-width: 100%; height: auto; margin-bottom: 1rem;"
           onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
      <h1 style="display: none; color: #00e0ff; font-size: 2rem; margin-bottom: 1rem;">CharlestonHacks Innovation Engine</h1>
      <p>Making Invisible Networks Visible</p>
      
      <div class="oauth-buttons">
        <button id="github-login" class="oauth-btn">
          <i class="fab fa-github"></i>
          Continue with GitHub
        </button>
        
        <button id="google-login" class="oauth-btn">
          <i class="fab fa-google"></i>
          Continue with Google
        </button>
      </div>
    </div>
  </div>

  <!-- OLD PROFILE SECTION REMOVED - NOW USING INLINE PROFILE EDITOR -->

  <!-- Fixed Header (Floating Overlay) -->
  <header class="unified-header hidden" id="main-header" style="position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: rgba(10, 14, 39, 0.95); backdrop-filter: blur(10px); border-bottom: 2px solid rgba(0, 224, 255, 0.3);">
    <div class="header-content">
      <div class="header-logo">
        <a href="https://charlestonhacks.com/" style="display: flex; align-items: center; text-decoration: none;">
          <img src="charlestonhackslogo.svg" 
               alt="CharlestonHacks" 
               style="height: 40px; width: auto; cursor: pointer;"
               onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <span style="display: none; color: #00e0ff; font-size: 1.5rem; font-weight: bold;">CharlestonHacks</span>
        </a>
      </div>
      
      <div class="header-search">
        <i class="fas fa-search"></i>
        <input type="text" id="global-search" placeholder="Search people, skills, projects...">
        <button id="search-button" onclick="handleGlobalSearch({key: 'Enter', target: document.getElementById('global-search')})" style="background: linear-gradient(135deg, #00e0ff, #0080ff); border: none; padding: 0.5rem 1rem; border-radius: 8px; color: white; cursor: pointer; margin-left: 0.5rem; font-weight: bold; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
          <i class="fas fa-arrow-right"></i> Search
        </button>
      </div>
      
      <div class="header-actions">
        <div class="header-notification" id="notifications-bell" onclick="scrollToSection('network')" style="cursor: pointer;" title="View pending requests">
          <i class="fas fa-bell"></i>
          <span class="notification-badge hidden" id="notif-count">0</span>
        </div>
        
        <div class="user-menu" id="user-menu" onclick="openProfileModal()" style="cursor: pointer;" title="View your profile">
          <div class="user-avatar" id="user-avatar-header">
            <span id="user-initials-header">?</span>
          </div>
          <span id="user-name-header">Loading...</span>
          <i class="fas fa-user-circle"></i>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Container - Fixed Non-Scrollable Page -->
  <!-- Main Container - Fullscreen Synapse with Overlays -->
  <div class="unified-main hidden" id="main-content" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; overflow: hidden;">
    
    <!-- Synapse Visualization (Fullscreen Background) -->
    <div id="synapse-main-view" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1;">
      <svg id="synapse-svg" style="width: 100%; height: 100%;"></svg>
    </div>

    <!-- Bottom Stats Bar (Floating Overlay) -->
    <div class="bottom-stats-bar" style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(10, 14, 39, 0.95); border-top: 2px solid rgba(0, 224, 255, 0.3); padding: 0.75rem 1rem; display: flex; gap: 0.75rem; overflow-x: auto; overflow-y: hidden; backdrop-filter: blur(10px); z-index: 100; scroll-behavior: smooth; -webkit-overflow-scrolling: touch;">
      
      <div class="stat-card-mini" onclick="openMessagesModal()" style="flex: 0 0 150px; min-width: 150px; cursor: pointer; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 8px; padding: 0.75rem; text-align: center; transition: all 0.2s;">
        <div class="icon" style="font-size: 1.5rem; color: #00e0ff; margin-bottom: 0.25rem;"><i class="fas fa-envelope"></i></div>
        <div class="value" id="unread-messages" style="font-size: 1.5rem; font-weight: bold; color: white;">0</div>
        <div class="label" style="font-size: 0.75rem; color: #aaa; text-transform: uppercase;">Messages</div>
      </div>

      <div class="stat-card-mini" onclick="openProjectsModal()" style="flex: 0 0 150px; min-width: 150px; cursor: pointer; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 8px; padding: 0.75rem; text-align: center; transition: all 0.2s;">
        <div class="icon" style="font-size: 1.5rem; color: #00e0ff; margin-bottom: 0.25rem;"><i class="fas fa-lightbulb"></i></div>
        <div class="value" id="active-projects" style="font-size: 1.5rem; font-weight: bold; color: white;">0</div>
        <div class="label" style="font-size: 0.75rem; color: #aaa; text-transform: uppercase;">Projects</div>
      </div>

      <div class="stat-card-mini" onclick="openEndorsementsModal()" style="flex: 0 0 150px; min-width: 150px; cursor: pointer; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 8px; padding: 0.75rem; text-align: center; transition: all 0.2s;">
        <div class="icon" style="font-size: 1.5rem; color: #00e0ff; margin-bottom: 0.25rem;"><i class="fas fa-star"></i></div>
        <div class="value" id="total-endorsements" style="font-size: 1.5rem; font-weight: bold; color: white;">0</div>
        <div class="label" style="font-size: 0.75rem; color: #aaa; text-transform: uppercase;">Endorsements</div>
      </div>

      <div class="stat-card-mini" style="flex: 0 0 150px; min-width: 150px; background: rgba(0,224,255,0.1); border: 1px solid rgba(0,224,255,0.3); border-radius: 8px; padding: 0.75rem; text-align: center;">
        <div class="icon" style="font-size: 1.5rem; color: #00e0ff; margin-bottom: 0.25rem;"><i class="fas fa-users"></i></div>
        <div class="value" id="network-size" style="font-size: 1.5rem; font-weight: bold; color: white;">0</div>
        <div class="label" style="font-size: 0.75rem; color: #aaa; text-transform: uppercase;">Network</div>
      </div>
      
      <!-- NEW: Action buttons from FABs - All using blue color scheme -->
      <div class="stat-card-mini" id="btn-bbs" onclick="document.getElementById('fab-bbs-trigger').click()" style="flex: 0 0 150px; min-width: 150px; cursor: pointer; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 8px; padding: 0.75rem; text-align: center; transition: all 0.2s;">
        <div class="icon" style="font-size: 1.5rem; color: #00e0ff; margin-bottom: 0.25rem;"><i class="fas fa-terminal"></i></div>
        <div class="label" style="font-size: 0.85rem; color: #00e0ff; text-transform: uppercase; margin-top: 0.5rem;">BBS</div>
      </div>

      <div class="stat-card-mini" onclick="openProfileModal()" style="flex: 0 0 150px; min-width: 150px; cursor: pointer; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 8px; padding: 0.75rem; text-align: center; transition: all 0.2s;">
        <div class="icon" style="font-size: 1.5rem; color: #00e0ff; margin-bottom: 0.25rem;"><i class="fas fa-user-edit"></i></div>
        <div class="label" style="font-size: 0.85rem; color: #00e0ff; text-transform: uppercase; margin-top: 0.5rem;">Edit Profile</div>
      </div>

      <div class="stat-card-mini" onclick="openQuickConnectModal()" style="flex: 0 0 150px; min-width: 150px; cursor: pointer; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 8px; padding: 0.75rem; text-align: center; transition: all 0.2s;">
        <div class="icon" style="font-size: 1.5rem; color: #00e0ff; margin-bottom: 0.25rem;"><i class="fas fa-user-plus"></i></div>
        <div class="label" style="font-size: 0.85rem; color: #00e0ff; text-transform: uppercase; margin-top: 0.5rem;">Quick Connect</div>
      </div>
    </div>

  </div>

  <!-- Hidden trigger for BBS -->
  <button id="fab-bbs-trigger" style="display: none;"></button>
  
  <!-- OLD SECTIONS REMOVED (Messages, Discovery, Connections, Innovation Hub, Profile) -->


  <!-- Floating Action Buttons removed - now in bottom bar -->

  <!-- Profile Modal -->
  <div class="modal" id="profile-modal">
    <div class="modal-content">
      <button class="modal-close" id="close-profile-modal">
        <i class="fas fa-times"></i>
      </button>
      <div id="modal-profile-content">
        <!-- Will be populated when viewing a profile -->
      </div>
    </div>
  </div>

  <!-- Messages Modal -->
  <div class="modal" id="messages-modal">
    <div class="modal-content" style="max-width: 900px;">
      <button class="modal-close" onclick="closeMessagesModal()">
        <i class="fas fa-times"></i>
      </button>
      <h2 style="color: #00e0ff; margin-bottom: 1.5rem;">
        <i class="fas fa-envelope"></i> Messages
      </h2>
      
      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem; height: 500px;">
        <!-- Conversations List -->
        <div style="background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 12px; padding: 1rem; overflow-y: auto;">
          <h3 style="color: #00e0ff; font-size: 0.9rem; margin-bottom: 1rem; text-transform: uppercase;">Conversations</h3>
          <div id="modal-conversations-list">
            <div style="text-align: center; color: #aaa; padding: 2rem;">
              <i class="fas fa-comments" style="font-size: 2rem; opacity: 0.3; margin-bottom: 0.5rem;"></i>
              <p>Loading conversations...</p>
            </div>
          </div>
        </div>
        
        <!-- Active Conversation -->
        <div style="background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 12px; padding: 1rem; display: flex; flex-direction: column;">
          <h3 id="modal-conversation-title" style="color: #00e0ff; font-size: 0.9rem; margin-bottom: 1rem; text-transform: uppercase;">Select a conversation</h3>
          
          <div id="modal-conversation-messages" style="flex: 1; overflow-y: auto; margin-bottom: 1rem; padding: 0.5rem;">
            <div style="text-align: center; color: #aaa; padding: 3rem;">
              <i class="fas fa-comment-dots" style="font-size: 3rem; opacity: 0.2;"></i>
              <p style="margin-top: 1rem;">Select a conversation to view messages</p>
            </div>
          </div>
          
          <div id="modal-message-input" style="display: none;">
            <form onsubmit="sendModalMessage(event)" style="display: flex; gap: 0.5rem;">
              <input type="text" id="modal-message-text" placeholder="Type a message..." style="flex: 1; padding: 0.75rem; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 8px; color: white; font-family: inherit;" required>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Projects Modal -->
  <div class="modal" id="projects-modal">
    <div class="modal-content" style="max-width: 800px;">
      <button class="modal-close" onclick="closeProjectsModal()">
        <i class="fas fa-times"></i>
      </button>
      <h2 style="color: #00e0ff; margin-bottom: 1.5rem;">
        <i class="fas fa-lightbulb"></i> Projects
      </h2>
      
      <div style="margin-bottom: 1.5rem;">
        <button onclick="showCreateProjectForm()" class="btn btn-primary">
          <i class="fas fa-plus"></i> New Project
        </button>
      </div>
      
      <div id="project-form" style="display: none; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
        <h3 style="color: #00e0ff; margin-bottom: 1rem;">Create New Project</h3>
        <form onsubmit="createProject(event)">
          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: #aaa; margin-bottom: 0.5rem;">Project Name *</label>
            <input type="text" id="project-name" required style="width: 100%; padding: 0.75rem; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 8px; color: white; font-family: inherit;">
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: #aaa; margin-bottom: 0.5rem;">Description *</label>
            <textarea id="project-description" rows="3" required style="width: 100%; padding: 0.75rem; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 8px; color: white; font-family: inherit; resize: vertical;"></textarea>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <label style="display: block; color: #aaa; margin-bottom: 0.5rem;">Required Skills (comma-separated)</label>
            <input type="text" id="project-skills" placeholder="e.g., JavaScript, React, Design" style="width: 100%; padding: 0.75rem; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 8px; color: white; font-family: inherit;">
          </div>
          
          <div style="display: flex; gap: 0.5rem;">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i> Create Project
            </button>
            <button type="button" onclick="hideCreateProjectForm()" class="btn" style="background: rgba(255,255,255,0.1);">
              Cancel
            </button>
          </div>
        </form>
      </div>
      
      <div id="projects-list" style="max-height: 400px; overflow-y: auto;">
        <div style="text-align: center; color: #aaa; padding: 2rem;">
          <i class="fas fa-folder-open" style="font-size: 3rem; opacity: 0.3;"></i>
          <p style="margin-top: 1rem;">Loading projects...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Endorsements Modal -->
  <div class="modal" id="endorsements-modal">
    <div class="modal-content" style="max-width: 700px;">
      <button class="modal-close" onclick="closeEndorsementsModal()">
        <i class="fas fa-times"></i>
      </button>
      <h2 style="color: #00e0ff; margin-bottom: 1.5rem;">
        <i class="fas fa-star"></i> Endorsements
      </h2>
      
      <div style="margin-bottom: 2rem;">
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
          <button onclick="showEndorsementsTab('received')" id="endorsements-tab-received" class="tab-btn active" style="flex: 1; padding: 0.75rem; background: linear-gradient(135deg, #00e0ff, #0080ff); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: bold;">
            Received
          </button>
          <button onclick="showEndorsementsTab('given')" id="endorsements-tab-given" class="tab-btn" style="flex: 1; padding: 0.75rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(0,224,255,0.2); border-radius: 8px; color: white; cursor: pointer;">
            Given
          </button>
        </div>
        
        <div id="endorsements-received" style="max-height: 400px; overflow-y: auto;">
          <div style="text-align: center; color: #aaa; padding: 2rem;">
            <i class="fas fa-star" style="font-size: 3rem; opacity: 0.3;"></i>
            <p style="margin-top: 1rem;">Loading endorsements...</p>
          </div>
        </div>
        
        <div id="endorsements-given" style="display: none; max-height: 400px; overflow-y: auto;">
          <div style="text-align: center; color: #aaa; padding: 2rem;">
            <i class="fas fa-star" style="font-size: 3rem; opacity: 0.3;"></i>
            <p style="margin-top: 1rem;">Loading endorsements...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Connect Modal -->
  <div class="modal" id="quick-connect-modal">
    <div class="modal-content" style="max-width: 800px;">
      <button class="modal-close" onclick="closeQuickConnectModal()">
        <i class="fas fa-times"></i>
      </button>
      <h2 style="color: #00e0ff; margin-bottom: 1.5rem;">
        <i class="fas fa-user-plus"></i> Quick Connect
      </h2>
      
      <p style="color: #aaa; margin-bottom: 1.5rem;">Connect with people who share your interests and skills</p>
      
      <div id="quick-connect-list" style="max-height: 500px; overflow-y: auto;">
        <div style="text-align: center; color: #aaa; padding: 2rem;">
          <i class="fas fa-users" style="font-size: 3rem; opacity: 0.3;"></i>
          <p style="margin-top: 1rem;">Loading suggested connections...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Fullscreen Synapse Container -->
  <!-- OLD SYNAPSE CONTAINER REMOVED - Synapse is now the main view -->

  <!-- BBS Modal -->
  <div id="bbs-modal">
    <!-- BBS content will be loaded here -->
  </div>

  </div>

  <!-- User badge and logout -->
  <div id="user-badge" class="hidden"></div>
  <button id="logout-btn" class="hidden">Sign Out</button>

  <!-- External modules -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <!-- Load Supabase client first -->
  <script type="module" src="assets/js/supabaseClient.js"></script>
  <script src="assets/js/ecosystem-connector.js"></script>
  <script src="assets/js/cynq.js"></script>
  <!-- Neural background -->
  <script src="assets/js/neuralBackground.js"></script>
  <!-- Load modular dashboard files in order -->
  <script type="module" src="auth.js"></script>
  <script type="module" src="profile.js"></script>
  <script type="module" src="dashboard.js"></script>
  <script type="module" src="main.js"></script>
  <!-- BBS System -->
  <script type="module">
    import { initBBS } from './assets/js/bbs.js';
    
    document.addEventListener('DOMContentLoaded', () => {
      const bbsBtn = document.getElementById('fab-bbs-trigger');
      if (bbsBtn) {
        bbsBtn.addEventListener('click', () => {
          initBBS();
        });
      }
    });
  </script>
  
  <!-- Synapse System - Auto-Initialize -->
  <script type="module">
    import { initSynapseView } from './assets/js/synapse.js';
    
    let synapseInitialized = false;
    
    // Initialize synapse automatically when user logs in (only once)
    window.addEventListener('profile-loaded', async () => {
      if (synapseInitialized) {
        console.log('üåê Synapse already initialized, skipping...');
        return;
      }
      
      console.log('üåê Auto-initializing synapse view...');
      synapseInitialized = true;
      await initSynapseView();
    });
  </script>
  
  <!-- Modal Integration - Using Existing Modules -->
  <script>
    // Immediate function stubs - prevent "not defined" errors
    // These will be replaced when the module loads
    // Modal control functions
    window.openMessagesModal = function() { 
      document.getElementById('messages-modal').classList.add('active');
    };
    window.closeMessagesModal = function() { 
      document.getElementById('messages-modal').classList.remove('active');
    };
    window.openProjectsModal = function() { 
      document.getElementById('projects-modal').classList.add('active');
    };
    window.closeProjectsModal = function() { 
      document.getElementById('projects-modal').classList.remove('active');
    };
    window.openEndorsementsModal = function() { 
      document.getElementById('endorsements-modal').classList.add('active');
    };
    window.closeEndorsementsModal = function() { 
      document.getElementById('endorsements-modal').classList.remove('active');
    };
    window.openQuickConnectModal = function() { 
      document.getElementById('quick-connect-modal').classList.add('active');
    };
    window.closeQuickConnectModal = function() { 
      document.getElementById('quick-connect-modal').classList.remove('active');
    };
    
    // ========================================
    // GLOBAL SEARCH FUNCTIONALITY
    // ========================================
    window.handleGlobalSearch = async function(event) {
      if (event.key !== 'Enter') return;
      
      const query = event.target.value.trim().toLowerCase();
      if (!query) return;
      
      console.log('üîç Searching for:', query);
      
      try {
        // Search community for people by name, skills, or bio
        const { data: people, error } = await window.supabase
          .from('community')
          .select('*')
          .or(`name.ilike.%${query}%,skills.ilike.%${query}%,bio.ilike.%${query}%`)
          .limit(20);
        
        if (error) throw error;
        
        // Also search projects
        const { data: projects } = await window.supabase
          .from('projects')
          .select('*')
          .or(`name.ilike.%${query}%,description.ilike.%${query}%,required_skills.ilike.%${query}%`)
          .limit(10);
        
        console.log('Found:', people?.length || 0, 'people and', projects?.length || 0, 'projects');
        
        // Show results in Quick Connect modal
        const modal = document.getElementById('quick-connect-modal');
        const content = document.getElementById('quick-connect-list');
        
        let html = '';
        
        // Show people results
        if (people && people.length > 0) {
          html += `<h3 style="color: #00e0ff; margin-bottom: 1rem;">People (${people.length})</h3>`;
          people.forEach(person => {
            const initials = person.name.split(' ').map(n => n[0]).join('').toUpperCase();
            html += `
              <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 12px; margin-bottom: 0.75rem;">
                ${person.image_url ? 
                  `<img src="${person.image_url}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #00e0ff;">` :
                  `<div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #00e0ff, #0080ff); display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; font-size: 1.2rem;">${initials}</div>`
                }
                <div style="flex: 1;">
                  <div style="color: white; font-weight: bold; font-size: 1rem;">${person.name}</div>
                  <div style="color: #aaa; font-size: 0.85rem;">${person.skills || 'No skills listed'}</div>
                </div>
                <button onclick="sendConnectionRequest('${person.id}')" class="btn btn-primary" style="white-space: nowrap;">
                  <i class="fas fa-user-plus"></i> Connect
                </button>
              </div>
            `;
          });
        }
        
        // Show project results
        if (projects && projects.length > 0) {
          html += `<h3 style="color: #00e0ff; margin: 1.5rem 0 1rem;">Projects (${projects.length})</h3>`;
          projects.forEach(project => {
            html += `
              <div style="padding: 1rem; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 12px; margin-bottom: 0.75rem;">
                <div style="color: #00e0ff; font-weight: bold; font-size: 1rem; margin-bottom: 0.5rem;">${project.name}</div>
                <div style="color: #aaa; font-size: 0.9rem; margin-bottom: 0.5rem;">${project.description || 'No description'}</div>
                ${project.required_skills ? `<div style="color: #666; font-size: 0.85rem;">Skills: ${project.required_skills}</div>` : ''}
              </div>
            `;
          });
        }
        
        if (html === '') {
          html = '<div style="text-align: center; padding: 3rem; color: #aaa;"><i class="fas fa-search" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i><p>No results found for "' + query + '"</p></div>';
        }
        
        content.innerHTML = html;
        modal.classList.add('active');
        
      } catch (error) {
        console.error('Search error:', error);
        alert('Search failed. Please try again.');
      }
    };

    // Attach search handler
    const searchInput = document.getElementById('global-search');
    if (searchInput) {
      searchInput.addEventListener('keypress', handleGlobalSearch);
    }

    // ========================================
    // USER BADGE CLICK TO PROFILE
    // ========================================
    const userBadge = document.getElementById('user-badge');
    if (userBadge) {
      userBadge.style.cursor = 'pointer';
      userBadge.addEventListener('click', () => {
        window.openProfileModal();
      });
    }
    
    window.openProfileModal = function() { document.getElementById('profile-modal').classList.add('active'); };
  </script>
  
  <script type="module">
    (async function() {
      try {
        console.log('üì¶ Starting module imports...');
        
        const { supabase } = await import('./assets/js/supabaseClient.js');
        window.supabase = supabase;  // Make supabase globally available
        console.log('‚úÖ supabaseClient loaded and attached to window');
        
        // Import your existing modules
        const connectionsModule = await import('./assets/js/connections.js');
        const { 
          initConnections, 
          sendConnectionRequest,
          getAcceptedConnections,
          getPendingRequestsReceived,
          acceptConnectionRequest,
          declineConnectionRequest
        } = connectionsModule;
        console.log('‚úÖ connections.js loaded');
        
        // Your IIFE modules auto-attach to window
        await import('./assets/js/endorsements.js');
        console.log('‚úÖ endorsements.js loaded');
        
        await import('./assets/js/messaging.js');
        console.log('‚úÖ messaging.js loaded');
        
        // Try to import projects module (optional - we have fallback functions defined)
        try {
          const projectsModule = await import('./assets/js/projects.js');
          const {
            initProjects,
            loadProjects
          } = projectsModule;
          
          // Override with module functions if available
          if (initProjects) window.initProjects = initProjects;
          if (loadProjects) window.loadProjects = loadProjects;
          
          console.log('‚úÖ projects.js loaded');
        } catch (err) {
          console.log('‚ÑπÔ∏è projects.js not found, using built-in functions');
        }
        
        console.log('‚úÖ All modules loaded successfully!');
    
    let currentUserProfile = null;
    let connectionsInitialized = false;
    
    // Initialize all systems when user logs in
    window.addEventListener('profile-loaded', async (e) => {
      currentUserProfile = e.detail.profile;
      
      console.log('üîå Initializing all modal systems...');
      
      // Initialize your existing modules
      if (!connectionsInitialized) {
        await initConnections(supabase);
        connectionsInitialized = true;
      }
      
      if (window.EndorsementsModule) {
        await window.EndorsementsModule.init();
      }
      
      // Initialize messaging module
      if (window.MessagingModule) {
        await window.MessagingModule.init();
      }
      
      // Initialize my projects module
      initProjects(currentUserProfile);
      
      console.log('‚úÖ All modal systems initialized');
    });
    
    // ========================
    // MESSAGES MODAL
    // ========================
    
    window.openMessagesModal = async function() {
      const modal = document.getElementById('messages-modal');
      modal.classList.add('active');
      
      // Your MessagingModule works perfectly with your existing tables!
      // Just need to load the conversation list into the modal
      await loadConversationsForModal();
    }
    
    window.closeMessagesModal = function() {
      document.getElementById('messages-modal').classList.remove('active');
    }
    
    async function loadConversationsForModal() {
      const listEl = document.getElementById('modal-conversations-list');
      
      // Get current auth user ID
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        listEl.innerHTML = '<div style="text-align: center; color: #aaa; padding: 2rem;">Please log in to view messages</div>';
        return;
      }
      
      console.log('üìß Loading conversations for user:', user.id);
      
      // Load conversations WITHOUT joins first (simpler query)
      const { data: conversations, error } = await supabase
        .from('conversations')
        .select('*')
        .or(`participant_1_id.eq.${user.id},participant_2_id.eq.${user.id}`)
        .order('last_message_at', { ascending: false });
      
      if (error) {
        console.error('Error loading conversations:', error);
        listEl.innerHTML = `<div style="text-align: center; color: #f44; padding: 2rem;">Error: ${error.message}</div>`;
        return;
      }
      
      console.log('‚úÖ Loaded conversations:', conversations?.length || 0);
      
      if (!conversations || conversations.length === 0) {
        listEl.innerHTML = `
          <div style="text-align: center; color: #aaa; padding: 2rem;">
            <i class="fas fa-comment-dots" style="font-size: 2rem; opacity: 0.3;"></i>
            <p style="margin-top: 0.5rem;">No conversations yet</p>
            <p style="font-size: 0.85rem;">Start messaging your connections!</p>
            <button onclick="closeMessagesModal(); openQuickConnectModal();" class="btn btn-primary" style="margin-top: 1rem;">
              <i class="fas fa-user-plus"></i> Find Connections
            </button>
          </div>
        `;
        return;
      }
      
      // Get participant IDs
      const participantIds = new Set();
      conversations.forEach(conv => {
        if (conv.participant_1_id !== user.id) participantIds.add(conv.participant_1_id);
        if (conv.participant_2_id !== user.id) participantIds.add(conv.participant_2_id);
      });
      
      // Load community profiles for these participants
      const { data: profiles } = await supabase
        .from('community')
        .select('id, user_id, name, image_url')
        .in('user_id', Array.from(participantIds));
      
      // Create lookup map
      const profileMap = {};
      (profiles || []).forEach(p => {
        profileMap[p.user_id] = p;
      });
      
      console.log('‚úÖ Loaded profiles:', profiles?.length || 0);
      
      let html = '';
      conversations.forEach(conv => {
        // Determine which participant is the "other" person
        const otherUserId = conv.participant_1_id === user.id ? conv.participant_2_id : conv.participant_1_id;
        const otherUser = profileMap[otherUserId];
        
        if (!otherUser) {
          console.warn('No profile for user:', otherUserId);
          return;
        }
        
        const initials = otherUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
        const lastMessagePreview = conv.last_message_preview || 'No messages yet';
        const timeAgo = conv.last_message_at ? formatTimeAgo(conv.last_message_at) : '';
        
        html += `
          <div onclick="openConversationById('${conv.id}', '${otherUser.name.replace(/'/g, "\\'")}', '${otherUserId}')" 
               style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.1); border-radius: 8px; cursor: pointer; margin-bottom: 0.5rem; transition: all 0.2s;"
               onmouseover="this.style.background='rgba(0,224,255,0.15)'; this.style.borderColor='rgba(0,224,255,0.3)'"
               onmouseout="this.style.background='rgba(0,224,255,0.05)'; this.style.borderColor='rgba(0,224,255,0.1)'">
            ${otherUser.image_url ? 
              `<img src="${otherUser.image_url}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #00e0ff;">` :
              `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #00e0ff, #0080ff); display: flex; align-items: center; justify-content: center; font-weight: bold; color: white;">${initials}</div>`
            }
            <div style="flex: 1; min-width: 0;">
              <div style="color: white; font-weight: bold; font-size: 0.9rem;">${otherUser.name}</div>
              <div style="color: #aaa; font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${lastMessagePreview}</div>
            </div>
            ${timeAgo ? `<div style="color: #666; font-size: 0.7rem;">${timeAgo}</div>` : ''}
          </div>
        `;
      });
      
      listEl.innerHTML = html;
      console.log('‚úÖ Conversations rendered');
    }
    
    async function loadConnectionsAsConversations() {
      const listEl = document.getElementById('modal-conversations-list');
      
      // Fallback: show connections if conversations query fails
      const connections = await getAcceptedConnections();
      
      if (!connections || connections.length === 0) {
        listEl.innerHTML = `
          <div style="text-align: center; color: #aaa; padding: 2rem;">
            <i class="fas fa-user-friends" style="font-size: 2rem; opacity: 0.3;"></i>
            <p style="margin-top: 0.5rem;">No connections yet</p>
            <p style="font-size: 0.85rem;">Connect with people to start messaging!</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      connections.forEach(conn => {
        const otherUser = conn.community;
        if (!otherUser) return;
        
        const initials = otherUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
        
        html += `
          <div onclick="startNewConversation('${otherUser.user_id || otherUser.id}', '${otherUser.name.replace(/'/g, "\\'")}', '${otherUser.id}')" 
               style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.1); border-radius: 8px; cursor: pointer; margin-bottom: 0.5rem; transition: all 0.2s;"
               onmouseover="this.style.background='rgba(0,224,255,0.15)'; this.style.borderColor='rgba(0,224,255,0.3)'"
               onmouseout="this.style.background='rgba(0,224,255,0.05)'; this.style.borderColor='rgba(0,224,255,0.1)'">
            ${otherUser.image_url ? 
              `<img src="${otherUser.image_url}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #00e0ff;">` :
              `<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #00e0ff, #0080ff); display: flex; align-items: center; justify-content: center; font-weight: bold; color: white;">${initials}</div>`
            }
            <div style="flex: 1; min-width: 0;">
              <div style="color: white; font-weight: bold; font-size: 0.9rem;">${otherUser.name}</div>
              <div style="color: #aaa; font-size: 0.75rem;">Start a conversation</div>
            </div>
          </div>
        `;
      });
      
      listEl.innerHTML = html;
    }
    
    window.openConversationById = async function(conversationId, userName, userId) {
      document.getElementById('modal-conversation-title').textContent = userName;
      document.getElementById('modal-message-input').style.display = 'block';
      
      // Load messages for this conversation
      await loadMessagesForConversation(conversationId);
    }
    
    window.startNewConversation = async function(authUserId, userName, communityId) {
      document.getElementById('modal-conversation-title').textContent = userName;
      document.getElementById('modal-message-input').style.display = 'block';
      
      const messagesEl = document.getElementById('modal-conversation-messages');
      messagesEl.innerHTML = `
        <div style="text-align: center; color: #aaa; padding: 2rem;">
          <i class="fas fa-comment-dots" style="font-size: 2rem; opacity: 0.3;"></i>
          <p style="margin-top: 0.5rem;">Start a conversation with ${userName}</p>
          <p style="font-size: 0.85rem; margin-top: 0.5rem;">Send your first message below!</p>
        </div>
      `;
      
      // Store for sending messages
      window.currentConversationData = { authUserId, userName, communityId };
    }
    
    async function loadMessagesForConversation(conversationId) {
      const messagesEl = document.getElementById('modal-conversation-messages');
      
      const { data: messages, error } = await supabase
        .from('messages')
        .select(`
          *,
          sender:community!messages_sender_id_fkey(name, image_url)
        `)
        .eq('conversation_id', conversationId)
        .order('created_at', { ascending: true });
      
      if (error) {
        console.error('Error loading messages:', error);
        messagesEl.innerHTML = `
          <div style="text-align: center; color: #f44; padding: 2rem;">
            <i class="fas fa-exclamation-circle"></i>
            <p>Error loading messages</p>
          </div>
        `;
        return;
      }
      
      if (!messages || messages.length === 0) {
        messagesEl.innerHTML = `
          <div style="text-align: center; color: #aaa; padding: 2rem;">
            <i class="fas fa-comment-dots" style="font-size: 2rem; opacity: 0.3;"></i>
            <p style="margin-top: 0.5rem;">No messages yet</p>
            <p style="font-size: 0.85rem;">Start the conversation!</p>
          </div>
        `;
        window.currentConversationId = conversationId;
        return;
      }
      
      const { data: { user } } = await supabase.auth.getUser();
      const { data: currentCommunity } = await supabase
        .from('community')
        .select('id')
        .eq('user_id', user.id)
        .single();
      
      let html = '';
      messages.forEach(msg => {
        const isSent = msg.sender_id === currentCommunity?.id;
        const senderName = isSent ? 'You' : (msg.sender?.name || 'Unknown');
        const initials = senderName.substring(0, 2).toUpperCase();
        const time = new Date(msg.created_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        
        html += `
          <div style="margin-bottom: 1rem; text-align: ${isSent ? 'right' : 'left'};">
            <div style="display: inline-block; max-width: 70%;">
              ${!isSent ? `<div style="color: #aaa; font-size: 0.75rem; margin-bottom: 0.25rem;">${senderName}</div>` : ''}
              <div style="background: ${isSent ? 'linear-gradient(135deg, #00e0ff, #0080ff)' : 'rgba(255,255,255,0.1)'}; padding: 0.75rem; border-radius: ${isSent ? '12px 12px 0 12px' : '12px 12px 12px 0'};">
                <p style="color: white; margin: 0; word-wrap: break-word;">${escapeHtml(msg.content)}</p>
              </div>
              <div style="color: #666; font-size: 0.7rem; margin-top: 0.25rem;">${time}</div>
            </div>
          </div>
        `;
      });
      
      messagesEl.innerHTML = html;
      messagesEl.scrollTop = messagesEl.scrollHeight;
      window.currentConversationId = conversationId;
      
      // Mark messages as read
      await supabase
        .from('messages')
        .update({ read: true })
        .eq('conversation_id', conversationId)
        .neq('sender_id', currentCommunity?.id);
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatTimeAgo(timestamp) {
      const seconds = Math.floor((new Date() - new Date(timestamp)) / 1000);
      if (seconds < 60) return 'now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d`;
      return new Date(timestamp).toLocaleDateString();
    }
    
    
    window.sendModalMessage = async function(event) {
      event.preventDefault();
      const input = document.getElementById('modal-message-text');
      const message = input.value.trim();
      
      if (!message) return;
      
      try {
        const { data: { user } } = await supabase.auth.getUser();
        const { data: currentCommunity } = await supabase
          .from('community')
          .select('id')
          .eq('user_id', user.id)
          .single();
        
        if (!currentCommunity) {
          alert('Please create your profile first');
          return;
        }
        
        let conversationId = window.currentConversationId;
        
        // If no conversation exists yet, create one
        if (!conversationId && window.currentConversationData) {
          const { authUserId } = window.currentConversationData;
          
          // Create conversation
          const { data: newConv, error: convError } = await supabase
            .from('conversations')
            .insert({
              participant_1_id: user.id < authUserId ? user.id : authUserId,
              participant_2_id: user.id < authUserId ? authUserId : user.id,
              last_message_at: new Date().toISOString(),
              last_message_preview: message.substring(0, 100)
            })
            .select()
            .single();
          
          if (convError) {
            console.error('Error creating conversation:', convError);
            alert('Failed to create conversation');
            return;
          }
          
          conversationId = newConv.id;
          window.currentConversationId = conversationId;
        }
        
        // Send message
        const { error: msgError } = await supabase
          .from('messages')
          .insert({
            conversation_id: conversationId,
            sender_id: currentCommunity.id,
            content: message,
            read: false
          });
        
        if (msgError) {
          console.error('Error sending message:', msgError);
          alert('Failed to send message');
          return;
        }
        
        // Update conversation last message
        await supabase
          .from('conversations')
          .update({
            last_message_at: new Date().toISOString(),
            last_message_preview: message.substring(0, 100)
          })
          .eq('id', conversationId);
        
        // Add message to UI
        const messagesEl = document.getElementById('modal-conversation-messages');
        const time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        const messageHtml = `
          <div style="margin-bottom: 1rem; text-align: right;">
            <div style="display: inline-block; max-width: 70%;">
              <div style="background: linear-gradient(135deg, #00e0ff, #0080ff); padding: 0.75rem; border-radius: 12px 12px 0 12px;">
                <p style="color: white; margin: 0; word-wrap: break-word;">${escapeHtml(message)}</p>
              </div>
              <div style="color: #666; font-size: 0.7rem; margin-top: 0.25rem;">${time}</div>
            </div>
          </div>
        `;
        
        if (messagesEl.querySelector('.fa-comment-dots')) {
          messagesEl.innerHTML = messageHtml;
        } else {
          messagesEl.innerHTML += messageHtml;
        }
        
        messagesEl.scrollTop = messagesEl.scrollHeight;
        input.value = '';
        
      } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message');
      }
    }
    
      event.preventDefault();
      
      if (window.MessagingModule && window.MessagingModule.handleSendClick) {
        window.MessagingModule.handleSendClick();
      } else {
        // Fallback
        const input = document.getElementById('modal-message-text');
        const message = input.value.trim();
        if (!message) return;
        
        const messagesEl = document.getElementById('modal-conversation-messages');
        const messageHtml = `
          <div style="margin-bottom: 1rem; text-align: right;">
            <div style="display: inline-block; max-width: 70%; background: linear-gradient(135deg, #00e0ff, #0080ff); padding: 0.75rem; border-radius: 12px 12px 0 12px;">
              <p style="color: white; margin: 0;">${message}</p>
              <p style="color: rgba(255,255,255,0.7); font-size: 0.7rem; margin: 0.25rem 0 0 0;">${new Date().toLocaleTimeString()}</p>
            </div>
          </div>
        `;
        
        if (messagesEl.querySelector('.fa-comment-dots')) {
          messagesEl.innerHTML = messageHtml;
        } else {
          messagesEl.innerHTML += messageHtml;
        }
        
        messagesEl.scrollTop = messagesEl.scrollHeight;
        input.value = '';
      }
    }
    
    // ========================
    // PROJECTS MODAL
    // ========================
    // (Functions already exposed to window in module loading section)

    // ========================
    // ENDORSEMENTS MODAL
    // ========================
    
    window.openEndorsementsModal = async function() {
      // Use your existing endorsements module
      const modal = document.getElementById('endorsements-modal');
      modal.classList.add('active');
      await loadEndorsementsData('received');
    }
    
    window.closeEndorsementsModal = function() {
      document.getElementById('endorsements-modal').classList.remove('active');
    }
    
    window.showEndorsementsTab = async function(tab) {
      // Update tab buttons
      document.getElementById('endorsements-tab-received').className = tab === 'received' ? 'tab-btn active' : 'tab-btn';
      document.getElementById('endorsements-tab-received').style.background = tab === 'received' ? 'linear-gradient(135deg, #00e0ff, #0080ff)' : 'rgba(255,255,255,0.1)';
      
      document.getElementById('endorsements-tab-given').className = tab === 'given' ? 'tab-btn active' : 'tab-btn';
      document.getElementById('endorsements-tab-given').style.background = tab === 'given' ? 'linear-gradient(135deg, #00e0ff, #0080ff)' : 'rgba(255,255,255,0.1)';
      
      // Show/hide content
      document.getElementById('endorsements-received').style.display = tab === 'received' ? 'block' : 'none';
      document.getElementById('endorsements-given').style.display = tab === 'given' ? 'block' : 'none';
      
      await loadEndorsementsData(tab);
    }
    
    async function loadEndorsementsData(type) {
      const containerEl = document.getElementById(`endorsements-${type}`);
      
      const query = type === 'received' 
        ? supabase.from('endorsements').select(`
            *,
            endorser:community!endorsements_endorser_community_id_fkey(name, image_url)
          `).eq('endorsed_community_id', currentUserProfile.id)
        : supabase.from('endorsements').select(`
            *,
            endorsed:community!endorsements_endorsed_community_id_fkey(name, image_url)
          `).eq('endorser_community_id', currentUserProfile.id);
      
      const { data: endorsements } = await query.order('created_at', { ascending: false });
      
      if (!endorsements || endorsements.length === 0) {
        containerEl.innerHTML = `
          <div style="text-align: center; color: #aaa; padding: 2rem;">
            <i class="fas fa-star" style="font-size: 3rem; opacity: 0.3;"></i>
            <p style="margin-top: 1rem;">No endorsements ${type === 'received' ? 'received' : 'given'} yet</p>
          </div>
        `;
        return;
      }
      
      // Group by skill
      const bySkill = {};
      endorsements.forEach(e => {
        if (!bySkill[e.skill]) bySkill[e.skill] = [];
        bySkill[e.skill].push(e);
      });
      
      let html = '';
      Object.entries(bySkill).forEach(([skill, endorsementList]) => {
        html += `
          <div style="background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
              <i class="fas fa-star" style="color: #ffd700; font-size: 1.2rem;"></i>
              <h3 style="color: #00e0ff; margin: 0;">${skill}</h3>
              <span style="background: rgba(0,224,255,0.2); color: #00e0ff; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">${endorsementList.length} ${endorsementList.length === 1 ? 'endorsement' : 'endorsements'}</span>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
              ${endorsementList.map(e => {
                const person = type === 'received' ? e.endorser : e.endorsed;
                const initials = person?.name ? person.name.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
                return `
                  <div style="display: flex; align-items: center; gap: 0.5rem; background: rgba(255,255,255,0.05); padding: 0.5rem 0.75rem; border-radius: 8px;">
                    ${person?.image_url ?
                      `<img src="${person.image_url}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;">` :
                      `<div style="width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, #00e0ff, #0080ff); display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; color: white;">${initials}</div>`
                    }
                    <span style="color: white; font-size: 0.9rem;">${person?.name || 'Unknown'}</span>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      });
      
      containerEl.innerHTML = html;
    }
    
    // ========================
    // GLOBAL SEARCH
    // ========================
    
    window.handleGlobalSearch = async function(query) {
      if (!query || !query.trim()) return;
      
      query = query.trim();
      console.log('üîç Searching for:', query);
      
      try {
        // Search in community table
        const { data: users, error } = await supabase
          .from('community')
          .select('*')
          .or(`name.ilike.%${query}%,skills.ilike.%${query}%,bio.ilike.%${query}%`)
          .limit(20);
        
        if (error) {
          console.error('Search error:', error);
          return;
        }
        
        console.log(`Found ${users?.length || 0} results for "${query}"`);
        
        // Show results in quick connect modal with search results
        const modal = document.getElementById('quick-connect-modal');
        modal.classList.add('active');
        
        const listEl = document.getElementById('quick-connect-list');
        
        if (!users || users.length === 0) {
          listEl.innerHTML = `
            <div style="text-align: center; color: #aaa; padding: 2rem;">
              <i class="fas fa-search" style="font-size: 3rem; opacity: 0.3;"></i>
              <p style="margin-top: 1rem;">No results found for "${query}"</p>
              <p style="font-size: 0.9rem; opacity: 0.7;">Try a different search term</p>
            </div>
          `;
          return;
        }
        
        // Get existing connections to show status
        const { data: connections } = await supabase
          .from('connections')
          .select('from_user_id, to_user_id, status')
          .or(`from_user_id.eq.${currentUserProfile.id},to_user_id.eq.${currentUserProfile.id}`);
        
        const connectionMap = new Map();
        connections?.forEach(conn => {
          const otherId = conn.from_user_id === currentUserProfile.id ? conn.to_user_id : conn.from_user_id;
          connectionMap.set(otherId, conn.status);
        });
        
        let html = `<h4 style="color: #00e0ff; margin-bottom: 1rem;">Search Results for "${query}"</h4>`;
        
        users.forEach(user => {
          if (user.id === currentUserProfile.id) return; // Skip self
          
          const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
          const connectionStatus = connectionMap.get(user.id);
          
          let actionButton = '';
          if (connectionStatus === 'accepted') {
            actionButton = '<span style="color: #00ff88; font-size: 0.9rem;"><i class="fas fa-check-circle"></i> Connected</span>';
          } else if (connectionStatus === 'pending') {
            actionButton = '<span style="color: #ffd700; font-size: 0.9rem;"><i class="fas fa-clock"></i> Pending</span>';
          } else {
            actionButton = `<button onclick="sendConnectionRequest('${user.id}')" style="background: linear-gradient(135deg, #00e0ff, #0080ff); border: none; padding: 0.5rem 1rem; border-radius: 8px; color: white; cursor: pointer; font-weight: bold;"><i class="fas fa-user-plus"></i> Connect</button>`;
          }
          
          const skills = user.skills ? user.skills.split(',').slice(0, 3).map(s => 
            `<span style="background: rgba(0,224,255,0.2); color: #00e0ff; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; margin-right: 0.5rem;">${s.trim()}</span>`
          ).join('') : '';
          
          html += `
            <div style="background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; display: flex; gap: 1rem; align-items: start;">
              ${user.image_url ?
                `<img src="${user.image_url}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #00e0ff; flex-shrink: 0;">` :
                `<div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #00e0ff, #0080ff); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: white; flex-shrink: 0;">${initials}</div>`
              }
              <div style="flex: 1; min-width: 0;">
                <h3 style="color: white; margin: 0 0 0.25rem 0; font-size: 1.1rem;">${user.name}</h3>
                ${user.bio ? `<p style="color: #aaa; font-size: 0.9rem; margin-bottom: 0.75rem; line-height: 1.4;">${user.bio.slice(0, 150)}${user.bio.length > 150 ? '...' : ''}</p>` : ''}
                ${skills ? `<div style="margin-bottom: 0.75rem;">${skills}</div>` : ''}
                <div style="display: flex; align-items: center; gap: 1rem;">
                  ${actionButton}
                </div>
              </div>
            </div>
          `;
        });
        
        listEl.innerHTML = html;
        
      } catch (err) {
        console.error('Search error:', err);
      }
    }
    
    // Setup search bar listener
    const globalSearchInput = document.getElementById('global-search');
    if (globalSearchInput) {
      globalSearchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleGlobalSearch(e.target.value);
        }
      });
    }
    
    // ========================
    // QUICK CONNECT MODAL
    // ========================
    
    window.openQuickConnectModal = async function() {
      const modal = document.getElementById('quick-connect-modal');
      modal.classList.add('active');
      await loadSuggestedConnections();
    }
    
    window.closeQuickConnectModal = function() {
      document.getElementById('quick-connect-modal').classList.remove('active');
    }
    
    async function loadSuggestedConnections() {
      const listEl = document.getElementById('quick-connect-list');
      
      // Get all users
      const { data: allUsers } = await supabase
        .from('community')
        .select('*')
        .neq('id', currentUserProfile.id);
      
      if (!allUsers) {
        listEl.innerHTML = '<div style="text-align: center; color: #aaa; padding: 2rem;">Error loading suggestions</div>';
        return;
      }
      
      // Get existing connections from your module
      const connections = await getAcceptedConnections();
      const pending = await getPendingRequestsReceived();
      
      const connectedIds = new Set();
      if (connections) {
        connections.forEach(c => connectedIds.add(c.otherUserId));
      }
      if (pending) {
        pending.forEach(p => connectedIds.add(p.from_user_id));
      }
      
      // Filter to non-connected users
      const suggestions = allUsers.filter(u => !connectedIds.has(u.id));
      
      // Score by shared skills
      const currentSkills = currentUserProfile.skills ? currentUserProfile.skills.toLowerCase().split(',').map(s => s.trim()) : [];
      suggestions.forEach(user => {
        const theirSkills = user.skills ? user.skills.toLowerCase().split(',').map(s => s.trim()) : [];
        user.matchScore = currentSkills.filter(s => theirSkills.includes(s)).length;
      });
      
      suggestions.sort((a, b) => b.matchScore - a.matchScore);
      
      if (suggestions.length === 0) {
        listEl.innerHTML = `
          <div style="text-align: center; color: #aaa; padding: 2rem;">
            <i class="fas fa-check-circle" style="font-size: 3rem; opacity: 0.3; color: #00ff88;"></i>
            <p style="margin-top: 1rem;">You're connected with everyone!</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      suggestions.slice(0, 20).forEach(user => {
        const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
        const sharedSkills = [];
        if (currentSkills.length && user.skills) {
          const theirSkills = user.skills.toLowerCase().split(',').map(s => s.trim());
          currentSkills.forEach(skill => {
            if (theirSkills.includes(skill)) sharedSkills.push(skill);
          });
        }
        
        html += `
          <div style="background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; display: flex; gap: 1rem; align-items: start;">
            ${user.image_url ?
              `<img src="${user.image_url}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #00e0ff; flex-shrink: 0;">` :
              `<div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #00e0ff, #0080ff); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: white; flex-shrink: 0;">${initials}</div>`
            }
            <div style="flex: 1; min-width: 0;">
              <h3 style="color: white; margin: 0 0 0.25rem 0; font-size: 1.1rem;">${user.name}</h3>
              ${user.bio ? `<p style="color: #aaa; font-size: 0.9rem; margin-bottom: 0.75rem;">${user.bio.slice(0, 100)}${user.bio.length > 100 ? '...' : ''}</p>` : ''}
              ${sharedSkills.length > 0 ? `
                <div style="margin-bottom: 0.75rem;">
                  <p style="color: #00ff88; font-size: 0.85rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-check-circle"></i> ${sharedSkills.length} shared ${sharedSkills.length === 1 ? 'skill' : 'skills'}
                  </p>
                  <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${sharedSkills.slice(0, 3).map(skill => `
                      <span style="background: rgba(0,255,136,0.2); color: #00ff88; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">${skill}</span>
                    `).join('')}
                    ${sharedSkills.length > 3 ? `<span style="color: #aaa; font-size: 0.85rem; padding: 0.25rem 0.5rem;">+${sharedSkills.length - 3} more</span>` : ''}
                  </div>
                </div>
              ` : ''}
              <button onclick="quickConnect(${user.id}, '${user.name.replace(/'/g, "\\'")}', this)" class="btn btn-primary" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                <i class="fas fa-user-plus"></i> Connect
              </button>
            </div>
          </div>
        `;
      });
      
      listEl.innerHTML = html;
    }
    
    window.quickConnect = async function(userId, userName, button) {
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
      
      try {
        // Use your existing connections module
        await sendConnectionRequest(userId);
        
        button.innerHTML = '<i class="fas fa-check"></i> Request Sent';
        button.style.background = 'rgba(0,255,136,0.2)';
        button.style.color = '#00ff88';
        
        setTimeout(() => {
          button.parentElement.parentElement.style.opacity = '0.5';
        }, 500);
      } catch (error) {
        console.error('Error sending connection request:', error);
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-user-plus"></i> Connect';
      }
    }
    
    // Profile Modal (existing)
    window.openProfileModal = function() {
      document.getElementById('profile-modal').classList.add('active');
    }
    
    // ========================
    // PROJECT FUNCTIONS
    // ========================
    window.openProjectsModal = async function() {
      document.getElementById('projects-modal').classList.add('active');
      try {
        await window.loadProjects(); // Load projects when modal opens
      } catch (err) {
        console.error('Error in openProjectsModal:', err);
      }
    }
    
    window.closeProjectsModal = function() {
      document.getElementById('projects-modal').classList.remove('active');
      hideCreateProjectForm();
    }
    
    window.showCreateProjectForm = function() {
      document.getElementById('project-form').style.display = 'block';
    }
    
    window.hideCreateProjectForm = function() {
      document.getElementById('project-form').style.display = 'none';
    }
    
    window.createProject = async function(event) {
      event.preventDefault();
      
      const projectName = document.getElementById('project-name').value;
      const projectDescription = document.getElementById('project-description').value;
      const projectSkills = document.getElementById('project-skills').value;
      
      try {
        // Get current user
        const { data: { user } } = await window.supabase.auth.getUser();
        if (!user) {
          alert('Please log in to create a project');
          return;
        }
        
        // Insert project
        const { data, error } = await window.supabase
          .from('projects')
          .insert({
            name: projectName,
            description: projectDescription,
            skills_needed: projectSkills,
            owner_id: user.id,
            status: 'active'
          })
          .select();
        
        if (error) throw error;
        
        alert('Project created successfully!');
        
        // Reset form
        document.getElementById('project-name').value = '';
        document.getElementById('project-description').value = '';
        document.getElementById('project-skills').value = '';
        
        hideCreateProjectForm();
        
        // Reload projects list
        await window.loadProjects();
        
      } catch (error) {
        console.error('Error creating project:', error);
        alert('Error creating project: ' + error.message);
      }
    }
    
    window.loadProjects = async function() {
      console.log('üîµ loadProjects called');
      const container = document.getElementById('projects-list');
      
      if (!container) {
        console.error('‚ùå projects-list container not found!');
        return;
      }
      
      try {
        console.log('üîµ Setting loading state...');
        container.innerHTML = '<div style="text-align: center; color: #aaa; padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i><p style="margin-top: 1rem;">Loading projects...</p></div>';
        
        console.log('üîµ Checking Supabase...');
        if (!window.supabase) {
          throw new Error('Supabase client not initialized');
        }
        
        // Fetch all projects
        console.log('üîµ Fetching projects from database...');
        const { data: projects, error } = await window.supabase
          .from('projects')
          .select(`
            *,
            owner:profiles!owner_id(id, name, avatar_url)
          `)
          .eq('status', 'active')
          .order('created_at', { ascending: false });
        
        console.log('üîµ Projects query result:', { projects, error });
        
        if (error) throw error;
        
        if (!projects || projects.length === 0) {
          console.log('‚ÑπÔ∏è No projects found');
          container.innerHTML = `
            <div style="text-align: center; color: #aaa; padding: 3rem;">
              <i class="fas fa-folder-open" style="font-size: 3rem; opacity: 0.3;"></i>
              <p style="margin-top: 1rem;">No projects yet</p>
              <p style="font-size: 0.9rem; margin-top: 0.5rem;">Click "New Project" to create one!</p>
            </div>
          `;
          return;
        }
        
        console.log(`‚úÖ Found ${projects.length} projects`);
        
        // Display projects
        container.innerHTML = projects.map(project => {
          const skills = project.skills_needed ? project.skills_needed.split(',').map(s => s.trim()) : [];
          const ownerName = project.owner?.name || 'Unknown';
          const createdDate = new Date(project.created_at).toLocaleDateString();
          
          return `
            <div class="project-card" style="background: rgba(0,224,255,0.05); border: 1px solid rgba(0,224,255,0.2); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; transition: all 0.2s;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div>
                  <h3 style="color: #00e0ff; margin-bottom: 0.5rem; font-size: 1.25rem;">
                    <i class="fas fa-lightbulb"></i> ${project.name}
                  </h3>
                  <p style="color: #aaa; font-size: 0.9rem;">
                    <i class="fas fa-user"></i> ${ownerName} ‚Ä¢ ${createdDate}
                  </p>
                </div>
                <span class="status-badge" style="background: rgba(0,255,136,0.2); color: #0f8; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">
                  ${project.status}
                </span>
              </div>
              
              <p style="color: #ddd; margin-bottom: 1rem; line-height: 1.5;">
                ${project.description}
              </p>
              
              ${skills.length > 0 ? `
                <div style="margin-bottom: 1rem;">
                  <p style="color: #aaa; font-size: 0.85rem; margin-bottom: 0.5rem;">Required Skills:</p>
                  <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                    ${skills.map(skill => `
                      <span style="background: rgba(0,224,255,0.1); color: #00e0ff; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; border: 1px solid rgba(0,224,255,0.2);">
                        ${skill}
                      </span>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                <button onclick="viewProject('${project.id}')" class="btn btn-sm" style="flex: 1; padding: 0.5rem 1rem; background: linear-gradient(135deg, #00e0ff, #0080ff); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: bold;">
                  <i class="fas fa-eye"></i> View Details
                </button>
                <button onclick="joinProject('${project.id}')" class="btn btn-sm" style="flex: 1; padding: 0.5rem 1rem; background: rgba(0,255,136,0.2); border: 1px solid rgba(0,255,136,0.3); border-radius: 8px; color: #0f8; cursor: pointer; font-weight: bold;">
                  <i class="fas fa-users"></i> Join Project
                </button>
              </div>
            </div>
          `;
        }).join('');
        
        console.log('‚úÖ Projects rendered successfully');
        
        // Add hover effect
        document.querySelectorAll('.project-card').forEach(card => {
          card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.borderColor = 'rgba(0,224,255,0.5)';
            this.style.boxShadow = '0 4px 12px rgba(0,224,255,0.2)';
          });
          card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.borderColor = 'rgba(0,224,255,0.2)';
            this.style.boxShadow = 'none';
          });
        });
        
      } catch (error) {
        console.error('‚ùå Error loading projects:', error);
        container.innerHTML = `
          <div style="text-align: center; color: #f66; padding: 2rem;">
            <i class="fas fa-exclamation-triangle" style="font-size: 2rem;"></i>
            <p style="margin-top: 1rem;">Error loading projects</p>
            <p style="font-size: 0.9rem; margin-top: 0.5rem;">${error.message}</p>
            <button onclick="window.loadProjects()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: linear-gradient(135deg, #00e0ff, #0080ff); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: bold;">
              <i class="fas fa-redo"></i> Retry
            </button>
          </div>
        `;
      }
    }
    
    window.viewProject = function(projectId) {
      console.log('View project:', projectId);
      // TODO: Implement project detail view
      alert('Project details view - coming soon!');
    }
    
    window.joinProject = async function(projectId) {
      try {
        const { data: { user } } = await window.supabase.auth.getUser();
        if (!user) {
          alert('Please log in to join a project');
          return;
        }
        
        // TODO: Add user to project members table
        console.log('Join project:', projectId);
        alert('Join project feature - coming soon! This will add you as a project member.');
        
      } catch (error) {
        console.error('Error joining project:', error);
        alert('Error joining project: ' + error.message);
      }
    }
    
      } catch (error) {
        console.error('‚ùå Error loading modules:', error);
        console.error('Module import failed:', error.message);
        console.error('Stack:', error.stack);
        
        // Show user-friendly error
        alert('Error loading dashboard modules. Please refresh the page.');
      }
    })(); // End async IIFE
  </script>
</body>
</html>
<style>
/* Bottom Stats Bar Hover Effects */
.stat-card-mini:hover {
  transform: translateY(-3px);
  background: rgba(0,224,255,0.15) !important;
  border-color: rgba(0,224,255,0.5) !important;
  box-shadow: 0 4px 12px rgba(0,224,255,0.3);
}

/* Fixed page - no scrolling */
body {
  overflow: hidden;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .bottom-stats-bar {
    gap: 0.25rem;
    padding: 0.5rem;
  }
  
  .stat-card-mini {
    padding: 0.5rem !important;
  }
  
  .stat-card-mini .label {
    font-size: 0.65rem !important;
  }
  
  .stat-card-mini .value {
    font-size: 1.25rem !important;
  }
}

/* Bottom Stats Bar Scrollbar */
.bottom-stats-bar::-webkit-scrollbar {
  height: 6px;
}

.bottom-stats-bar::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.3);
}

.bottom-stats-bar::-webkit-scrollbar-thumb {
  background: rgba(0, 224, 255, 0.3);
  border-radius: 3px;
}

.bottom-stats-bar::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 224, 255, 0.5);
}

/* Make stat cards fixed width for scrolling */
.bottom-stats-bar > div {
  flex: 0 0 auto;
  min-width: 150px;
}
</style>
